# Pico Launchpad Tonnetz

This project is a spinoff of a [sketchpad repository where I created lots of
Launchpad setups](https://github.com/duhrer/flocking-midi-interchange). The
skeleton for this repository was cloned from [my Launchpad-specific template
repository on GitHub](https://github.com/duhrer/pico-launchpad), see that
project for more technical details.

The code provided here allows you to program a microcontroller to retune a
Novation Launchpad to use ["Tonnetz"
tuning](https://en.wikipedia.org/wiki/Tonnetz). On a piano keyboard, an octave
is arrangedd from left to right, and wraps left and right as well:

![Piano octave](/images/piano-octave.svg)

In a "Tonnetz" instrument, things are arranged so that each type of chord has a
particular "shape", and so that that shape can be transposed to any other
position to play the same type of chord:

![Tonnetz octave](/images/tonnetz-octave.svg)

There are quite a few MIDI controllers that support this kind of offset
arrangement, but the commercial ones are eye-wateringly expensive. Roughly five
years ago, after staring at the Wikipedia version of the above diagram, I
realised I could adapt this approach for use with Novation Launchpad grid
controllers. See "Actually Using Everything" below for more details.

## Hardware Prerequisites

To use this project, you need a supported Novation Launchpad. This project is
currently tested with the Launchpad S, the Launchpad Pro MK2 and the Launchpad
Pro MK3. Have something else? Let me know if it works (if it doesn't, I'm happy
to work together to add support).

You'll also need a compatible micro-controller, i.e. a Pico, Pico 2, or
compatible third-party unit. If your device has a second USB port, you can plug
the Launchpad directly into that. The "host" code in this project has mainly
been mainly tested with [a RP2350-based Waveshare
unit](https://www.waveshare.com/wiki/RP2350-USB-A), for anything else at a
minimum you'll need to adjust some ports in `pico-launchpad-tonnetz.c`.

## Software Prerequisites

Once you have something to run the code on, you'll need to set up a build
environment. In the past, I have used:

1. The [Getting Started with Pico Guide](https://datasheets.raspberrypi.org/pico/getting-started-with-pico.pdf)
2. The [Pico VS Code extension](https://github.com/raspberrypi/pico-vscode)

Both of those are probably the easiest starting points, and if you hit upon
questions, there are lots of people working with them, so hopefully you can find
the guidance you need.

Personally, I use [distrobox](https://distrobox.it/) and [the docker container
created by `lukstep`](https://github.com/lukstep/raspberry-pi-pico-docker-sdk),
which I set up using commands like:

```
distrobox-create --image lukstep/raspberry-pi-pico-sdk -n pico-sdk
distrobox enter pico-sdk
```

## Checking out the Code

This project uses [git
submodules](https://git-scm.com/book/en/v2/Git-Tools-Submodules) for the
libraries it relies on. This means that if you
[clone](https://git-scm.com/docs/git-clone) this repository, you won't have all
the code you need to successfully build binaries.

Although there are multiple ways to manage submodules, the simplest way to get
everything you need is to use a command like:

```
git clone --recurse-submodules https://github.com/duhrer/pico-midi-transformer.git
```

## Building

Before you build the code, you should check the pin settings in
`pico-launchpad-tonnetz.c` to confirm that they match your unit (there are commented out
sections for the tested boards mentioned above).

Once you have a working build environment and have updated your pin settings as
needed, you should be able to build the code in this project using commands
like:

```
mkdir -p build
cd build
cmake ..
make -j8
```

You should end up with binaries in various formats.

## Installing on a Microcontroller

The simplest way to install a binary is to boot the microcontroller into
`bootsel` mode. Hold down the `bootsel` button and plug your microcontroller
into USB. A USB drive will appear, and you can copy the
`pico-launchpad-tonnetz.uf2` file generated by the build process onto your unit.
It will process and install the binary if it can. If it doesn't do anything,
make sure you're building for the right processor family, and try other test
binaries, like the examples that come with [the Pico
SDK](https://github.com/raspberrypi/pico-sdk).

If you're lucky enough to have a board with a reset button, all of the binaries
in this project also support entering `bootsel` mode by pressing the reset
button twice. You then copy the `pico-launchpad-tonnetz.uf2` file to the USB
drive as described above.

If you have a [pico probe](https://www.raspberrypi.com/products/debug-probe/) or
other debugging unit, and if your microcontroller exposes the ports you need,
you can use `openocd` to deploy binaries. With this method, you deploy one of
the `pico-launchpad-tonnetz.elf` file generated during the build process. Check
the "[Getting Started with Pico
Guide](https://datasheets.raspberrypi.com/pico/getting-started-with-pico.pdf)"
for more info.

## Setting Up Your Launchpad(s)

### Host Mode

If you have a compatible dual-USB unit, you should be able to connect the
Launchpad to your "host" port, and it should power on. Currently, I can't send
the sysex messages required to set up a Launchpad connected to the "host" port,
so you'll need to enter programmer mode on devices that support it. On the
Launchpad Pro MK2, this is accomplished by holding down the setup button and
then hitting the orange pad in the top row of "modes". On the Launchpad Pro
MK3, you need to hold the setup button in the lower left of the unit, use the
bottom row of controls to change to the "pad" menu, and then hit the bottom
right arrow to switch to programmer mode. Check your user guide if you need
more help than that.

### Client Mode

If you don't have a "host" port on your unit or want to connect more than one
Launchpad at a time, you'll need to connect things on the "client" side, i.e.
using code running on your computer. First, you need to connect both the
microcontroller and the Launchpad to your computer. You'll also need to
configure software like [midiconn](https://github.com/mfep/midiconn) to route
messages in both directions between the microcontroller and the Launchpad, as
shown here:

![Wiring Diagram](images/connection-map.png)

The key thing to note is that each generation has different ports that need to
be used. The first generation only has one input and output, those connect to
the MK1 input and output as shown above. The Launchpad Pro MK2 has three inputs
and three outputs, the second of each set ("Standalone") is the one you need to
connoect to the MK2 input and output. The Launchpad Pro MK3 has multiple virtual
ports, but you only need to connect the first in each set (the one labelled
"MIDI").


## Actually Using Everything

Now that you've set up all your hardware and software, you can actually play
something. Let's look at the default tuning:

![Default tuning, with triangles](/images/default-tuning-triangles.svg)

To help orient you, all C notes are highlighted in red. The rest of the
"naturals" are white. All sharps and flats are black (unlit). Any pad that's
held down will be highlighted in blue.

### Making Chords

Let's go through making two simple chords using triangles. The first side of the
triangle consists of adjacent notes on a diagonal from lower left to upper
right, such as C and G. If we make a triangle that points up and to the left (by
adding E), we make a major triad. If we start with C and G and make a triangle
that points down and to the right (by adding D#), we make a minor triad. If you
arrange your fingers for a particular chord pattern, that same pattern will play
the same type of chord anywhere in our range.

Just to extend this example a little, if we start with our C-E-G triangle and
extend it to a trapezoid that includes the B, we have the pattern for [a major
7th chord](https://en.wikipedia.org/wiki/Major_seventh_chord). The same pattern
will play a major 7th chord anywhere in our range.

### Adjusting the Note Range

If you want to reach a different range of notes, you can adjust the note range
using the arrow pads on your Launchpad. Hitting the left arrow pad will shift
the range of notes three semitones lower. Hitting the right arrow pad will
shift the range of notes three semitones higher. Hitting the up arrow pad will
shift the range of notes four semitones higher. Hitting the down arrow pad will
shift the range of notes four semitones lower.

### Using Multiple Launchpads

Although you can only connect one Launchpad to the "host" port (see above), you
can connect as many as you like in "client mode" (see above). The default tuning
can be "tiled" both vertically and horizontally. However, this will result in
"jumps" from one octave to another.

If you want to fix this, you can adjust the note range (see above). Note that
all adjustments are "per family", i.e. everything connected to the `MK3` output
will use (and control) the same offset.

Just use the arrow pads until both the pattern and the octaves align. If you
want to position a second Launchpad to the right of another Launchpad that uses
the default tuning, you can either tap the right arrow 8 times (8x3 semitones),
or tap the up arrow six times (6x4 semitones). If you want to position a second
Launchpad above another, tap the up arrow 9 times (9 x 4 semitones) or tap the
right arrow 12 times (12 x 3 semitones).
